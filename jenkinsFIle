pipeline {
    agent { label 'linux-node' }
    stages {
        stage('Validar disco') {
            steps {
                script {
                    def rutaLogs = "/var/log/app"
                    def umbral = 95

                    // Uso actual en porcentaje
                    def usoActual = sh(script: "df -h / | awk 'NR==2 {print substr(\$5, 1, length(\$5)-1)}'", returnStdout: true).trim().toInteger()
                    echo "ðŸ“Š Uso actual del disco: ${usoActual}%"

                    if (usoActual > umbral) {
                        echo "âš ï¸ El disco estÃ¡ por encima del ${umbral}%, evaluando limpieza..."

                        // Calcular tamaÃ±o total de logs >30 dÃ­as (en MB)
                        def tamLogs = sh(script: "find ${rutaLogs} -type f -mtime +30 -exec du -cm {} + | tail -n1 | awk '{print \$1}'", returnStdout: true).trim()
                        tamLogs = tamLogs.isEmpty() ? 0 : tamLogs.toInteger()

                        echo "ðŸ“‚ TamaÃ±o de logs a eliminar (>30 dÃ­as): ${tamLogs} MB"

                        if (tamLogs > 0) {
                            // Espacio libre actual en MB
                            def libreMB = sh(script: "df -m / | awk 'NR==2 {print \$4}'", returnStdout: true).trim().toInteger()
                            def totalMB = sh(script: "df -m / | awk 'NR==2 {print \$2}'", returnStdout: true).trim().toInteger()

                            def librePost = libreMB + tamLogs
                            def usoPost = 100 - ((librePost * 100) / totalMB)

                            echo "ðŸ“Š Uso estimado despuÃ©s de limpiar: ${usoPost.intValue()}%"

                            if (usoPost < umbral) {
                                echo "âœ… Se eliminarÃ¡n los logs viejos para liberar espacio"
                                sh "find ${rutaLogs} -type f -mtime +30 -delete"
                            } else {
                                echo "âŒ AÃºn eliminando logs no bajamos del ${umbral}%, se requiere otra acciÃ³n"
                            }
                        } else {
                            echo "âŒ No hay logs mayores a 30 dÃ­as para eliminar"
                        }
                    } else {
                        echo "âœ… El disco estÃ¡ por debajo del ${umbral}%, no es necesario limpiar"
                    }
                }
            }
        }
    }
}

pipeline {
    agent any

    environment {
        NEXUS_URL = "https://nexus.tuempresa.com/repository/automation-status/automation_status.json"
        NEXUS_USER = credentials('nexus-user')
        NEXUS_PASS = credentials('nexus-pass')
        FILE_NAME = "automation_status.json"
    }

    stages {
        stage('Ejemplo de ejecución') {
            steps {
                echo "Aquí iría la lógica principal del pipeline..."
                // error("Forzar fallo para probar el post") // Descomenta para probar el bloque failure
            }
        }
    }

    post {
        success {
            script {
                echo "✅ Pipeline finalizado con éxito. Estado: UP"
                updateStatus("UP")
            }
        }
        failure {
            script {
                echo "❌ Pipeline fallido. Estado: DOWN"
                updateStatus("DOWN")
            }
        }
    }
}

// --- Función Groovy dentro del Jenkinsfile ---
def updateStatus(String newStatus) {
    def jsonFile = env.FILE_NAME
    def pipelineName = env.JOB_NAME

    sh """
        echo "Descargando JSON desde Nexus..."
        curl -u $NEXUS_USER:$NEXUS_PASS -s -o $jsonFile $NEXUS_URL
    """

    def data = readJSON file: jsonFile

    if (data.containsKey(pipelineName)) {
        echo "Actualizando estado de ${pipelineName} a ${newStatus}"
        data[pipelineName] = newStatus
    } else {
        echo "Agregando nueva automatización: ${pipelineName}"
        data[pipelineName] = newStatus
    }

    writeJSON file: jsonFile, json: data, pretty: 4

    sh """
        echo "Subiendo JSON actualizado a Nexus..."
        curl -u $NEXUS_USER:$NEXUS_PASS -X PUT -T $jsonFile $NEXUS_URL
    """
}

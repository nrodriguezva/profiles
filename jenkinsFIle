pipeline {
  agent any
  stages {
    stage('TEA via Docker expect') {
      steps {
        withCredentials([usernamePassword(credentialsId: 'tea-creds', usernameVariable: 'SSH_USER', passwordVariable: 'SSH_PASS')]) {
          script {
            docker.image('ubuntu:22.04').inside {
              sh '''
                apt-get update && apt-get install -y expect openssh-client >/dev/null
                cat > /tmp/ssh_tea_expect.exp <<'EOF'
                #!/usr/bin/expect -f
                set timeout 30
                set host "10.171.183.76"
                set port "10608"
                set user "$env(SSH_USER)"
                set pass "$env(SSH_PASS)"
                set cmds [list "list users" "exit"]
                spawn ssh -p $port -o StrictHostKeyChecking=no -o PasswordAuthentication=yes $user@$host
                expect {
                  -re "Are you sure you want to continue connecting.*" { send "yes\r"; exp_continue }
                  -re "(P|p)assword:" { send "$pass\r" }
                }
                expect { -re "TEA> $|TEA>.*|\\$ $|# $" {} timeout {} }
                foreach c $cmds {
                  send "$c\r"
                  expect { -re "TEA> $|TEA>.*|\\$ $|# $" {} timeout {} }
                }
                expect eof
                EOF
                chmod +x /tmp/ssh_tea_expect.exp
                /tmp/ssh_tea_expect.exp
              '''
            }
          }
        }
      }
    }
  }
}
